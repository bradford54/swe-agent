# Pilot SWE - Software Engineering Agent

[![Go Version](https://img.shields.io/badge/Go-1.25%2B-00ADD8?style=flat&logo=go)](https://go.dev/)
[![Test Coverage](https://img.shields.io/badge/coverage-65.3%25-brightgreen)](./TEST_COVERAGE_REPORT.md)
[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![GitHub](https://img.shields.io/badge/GitHub-cexll%2Fswe-181717?logo=github)](https://github.com/cexll/swe)

GitHub App webhook 服务，通过 `/pilot` 命令触发 AI 自动完成代码修改任务。

> 🎯 **核心理念**: 用 AI 赋能开发者，让代码修改变得像评论一样简单。

## 📖 目录

- [特性](#-特性)
- [快速开始](#快速开始)
- [使用方法](#使用方法)
- [架构设计](#️-架构设计)
- [测试](#-测试)
- [开发](#-开发)
- [部署](#-部署)
- [路线图](#️-路线图)

## ✨ 特性

- 🤖 **AI 驱动** - 基于 Claude Code CLI，可扩展多 AI provider
- 🔐 **安全验证** - GitHub webhook 签名验证（HMAC SHA-256）
- ⚡ **异步处理** - 立即响应 webhook，后台执行任务
- 📦 **自动化流程** - Clone → AI 修改 → Commit → Push → 创建 PR 链接
- 🎯 **可配置触发词** - 默认 `/pilot`，可自定义
- 🎨 **Clean Architecture** - Provider 接口抽象，易于扩展
- ✅ **高测试覆盖率** - 65.3% 单元测试覆盖率，8 个测试文件

## 📊 项目统计

| 指标           | 数值                                          |
| -------------- | --------------------------------------------- |
| **代码量**     | 12 个 Go 文件，~800 行代码                    |
| **测试覆盖率** | 65.3% ([详细报告](./TEST_COVERAGE_REPORT.md)) |
| **测试文件**   | 8 个测试文件，95+ 测试函数                    |
| **编译产物**   | 8.3MB 单一二进制文件                          |
| **依赖**       | Minimal - Go 1.25+, Claude CLI, gh CLI        |
| **性能**       | 启动 ~100ms，内存 ~50MB                       |

## 快速开始

### 前置要求

- Go 1.25+
- [Claude Code CLI](https://github.com/anthropics/claude-code)
- [GitHub CLI](https://cli.github.com/)
- Claude API Key (或 Codex API Key)

### 安装

```bash
# 1. 克隆项目
git clone git@github.com:cexll/swe.git
cd swe

# 2. 安装依赖
go mod download

# 3. 复制环境变量模板
cp .env.example .env

# 4. 编辑 .env 填入你的配置
# GITHUB_APP_ID=your-app-id
# GITHUB_PRIVATE_KEY="your-private-key"
# GITHUB_WEBHOOK_SECRET=your-webhook-secret
# ANTHROPIC_API_KEY=sk-ant-xxx
```

### 环境变量

```bash
# GitHub App 配置
GITHUB_APP_ID=123456
GITHUB_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n..."
GITHUB_WEBHOOK_SECRET=your-webhook-secret

# AI Provider 配置 (二选一)
# 选项 1: Claude
PROVIDER=claude
ANTHROPIC_API_KEY=sk-ant-xxx
CLAUDE_MODEL=claude-3-5-sonnet-20241022

# 选项 2: Codex
# PROVIDER=codex
# CODEX_API_KEY=your-codex-key
# CODEX_MODEL=gpt-5-codex

# 可选配置
TRIGGER_KEYWORD=/pilot
PORT=3000
```

### 本地运行

```bash
# 加载环境变量
source .env  # 或使用 export 逐个设置

# 运行服务
go run cmd/main.go
```

服务启动后，访问：

- 🏠 服务信息: http://localhost:3000/
- ❤️ 健康检查: http://localhost:3000/health
- 🔗 Webhook: http://localhost:3000/webhook

## 使用方法

### 1. 配置 GitHub App

1. **创建 GitHub App**: https://github.com/settings/apps/new
2. **权限设置**:
   - Repository permissions:
     - ✅ Contents: Read & Write
     - ✅ Issues: Read & Write
     - ✅ Pull requests: Read & Write
   - Subscribe to events:
     - ✅ Issue comments
3. **Webhook 设置**:
   - URL: `https://your-domain.com/webhook`
   - Secret: 生成一个随机密钥
   - Content type: `application/json`
4. **安装到仓库**

### 2. 在 Issue/PR 评论中触发

在任何 Issue 或 PR 中评论：

```
/pilot fix the typo in README.md
```

```
/pilot add error handling to the main function
```

```
/pilot refactor the database connection code
```

### 3. Pilot 自动执行

Pilot 会自动完成以下流程：

1. ✅ **Clone 仓库** - 下载最新代码
2. ✅ **AI 生成** - 调用 Claude 生成修改
3. ✅ **应用修改** - 写入文件系统
4. ✅ **Commit** - 提交到新分支
5. ✅ **Push** - 推送到远程
6. ✅ **回复评论** - 提供 PR 创建链接

### 4. 查看结果

Pilot 会在原评论下自动回复：

```markdown
### ✅ Task Completed Successfully

**Summary:** Fixed typo in README.md

**Modified Files:** (1)

- `README.md`

**Next Step:**
[🚀 Click here to create Pull Request](https://github.com/owner/repo/compare/main...pilot/123-1234567890?expand=1)

---

_Generated by Pilot SWE_
```

## API 端点

### POST /webhook

接收 GitHub webhook 事件

**Headers:**

- `X-Hub-Signature-256`: GitHub webhook 签名
- `Content-Type`: application/json

**Body:** GitHub issue_comment event payload

**Response:**

- `202 Accepted`: 任务已接受，后台处理中
- `401 Unauthorized`: 签名验证失败
- `400 Bad Request`: 请求格式错误

### GET /health

健康检查端点

**Response:** `200 OK`

### GET /

服务信息

**Response:**

```json
{
  "service": "pilot-swe",
  "status": "running",
  "trigger": "/pilot"
}
```

## 🏗️ 架构设计

### 目录结构

```
swe/
├── cmd/
│   └── main.go                          # HTTP 服务器入口
├── internal/
│   ├── config/
│   │   ├── config.go                    # 配置管理
│   │   └── config_test.go               # 配置测试 (100% 覆盖)
│   ├── webhook/
│   │   ├── handler.go                   # Webhook 事件处理
│   │   ├── verify.go                    # HMAC 签名验证
│   │   ├── types.go                     # Webhook payload 类型
│   │   ├── handler_test.go              # 处理器测试 (96.6% 覆盖)
│   │   └── verify_test.go               # 验证测试 (100% 覆盖)
│   ├── provider/
│   │   ├── provider.go                  # Provider 接口定义
│   │   ├── factory.go                   # Provider 工厂
│   │   ├── factory_test.go              # 工厂测试 (100% 覆盖)
│   │   ├── claude/                      # Claude Provider 实现
│   │   │   ├── claude.go
│   │   │   └── claude_test.go           # (65.6% 覆盖)
│   │   └── codex/                       # Codex Provider 实现
│   │       ├── codex.go
│   │       └── codex_test.go
│   ├── github/
│   │   ├── auth.go                      # GitHub App 认证
│   │   ├── clone.go                     # gh repo clone
│   │   ├── comment.go                   # gh issue comment
│   │   ├── pr.go                        # gh pr create
│   │   ├── auth_test.go
│   │   └── github_test.go               # GitHub 操作测试 (63.2% 覆盖)
│   └── executor/
│       ├── task.go                      # 任务执行器（核心流程）
│       ├── task_test.go                 # 任务测试
│       └── executor_extended_test.go    # 扩展测试 (48.2% 覆盖)
├── Dockerfile                           # Docker 构建文件
├── .env.example                         # 环境变量模板
├── .gitignore                           # Git 忽略文件
├── go.mod                               # Go 模块定义
├── go.sum                               # Go 依赖锁定
├── CLAUDE.md                            # Claude Code 开发指南
├── README.md                            # 项目文档
└── TEST_COVERAGE_REPORT.md              # 测试覆盖率详细报告
```

### 架构亮点（Linus 风格）

#### 1. Provider 抽象 - 消除特殊分支

```go
// 好品味的设计：无 if provider == "claude" 分支
type Provider interface {
    GenerateCode(ctx context.Context, req *CodeRequest) (*CodeResponse, error)
    Name() string
}

// 工厂模式统一创建
provider.NewProvider(&Config{
    Name:         "claude",  // 未来可改为 "codex", "gemini"
    ClaudeAPIKey: "...",
})

// 新增 provider 只需：
// 1. 实现 Provider 接口
// 2. 在 factory.go 添加 case
// 零修改现有代码！
```

#### 2. 清晰的数据流

```
GitHub Webhook
      ↓
  Handler (验证签名)
      ↓
  Executor (编排)
      ↓
  Provider (AI 生成)
      ↓
  GitHub Ops (操作)
      ↓
  Comment (反馈)
```

#### 3. 错误处理策略

```go
// 失败时自动回复错误评论到 GitHub
if err != nil {
    return e.notifyError(task, errorMsg)
    // 用户在 GitHub 看到详细错误，无需查日志
}
```

### 核心组件

| 组件            | 职责                                         | 文件数 | 测试覆盖率 |
| --------------- | -------------------------------------------- | ------ | ---------- |
| Webhook Handler | 接收、验证、解析 GitHub 事件                 | 3      | 96.6%      |
| Provider        | AI 代码生成抽象层                            | 3      | 100%       |
| Executor        | 任务编排（Clone → Generate → Commit → Push） | 1      | 48.2%      |
| GitHub Ops      | Git 操作封装（基于 gh CLI）                  | 3      | 63.2%      |
| Config          | 环境变量管理和验证                           | 1      | 100%       |

## 🧪 测试

### 运行测试

```bash
# 运行所有测试
go test ./...

# 运行测试并显示覆盖率
go test ./... -cover

# 生成覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html

# 查看详细覆盖率
go tool cover -func=coverage.out
```

### 测试覆盖率

| 包                       | 覆盖率    | 状态        |
| ------------------------ | --------- | ----------- |
| internal/config          | 100.0%    | ✅ 优秀     |
| internal/provider        | 100.0%    | ✅ 优秀     |
| internal/webhook         | 96.6%     | ✅ 优秀     |
| internal/provider/claude | 65.6%     | ⚠️ 良好     |
| internal/github          | 63.2%     | ⚠️ 良好     |
| internal/executor        | 48.2%     | ⚠️ 需改进   |
| **总体**                 | **65.3%** | **✅ 良好** |

详细测试报告请查看 [TEST_COVERAGE_REPORT.md](./TEST_COVERAGE_REPORT.md)

## 💻 开发

> 💡 **开发者提示**: 查看 [CLAUDE.md](./CLAUDE.md) 获取完整的开发指南，包括架构说明、测试策略和代码规范。

### 构建

```bash
# 本地构建
go build -o pilot-swe cmd/main.go

# 运行
./pilot-swe
```

### 代码格式化

```bash
# 格式化代码
go fmt ./...

# 代码检查
go vet ./...

# 整理依赖
go mod tidy
```

### 添加新的 AI Provider

1. 在 `internal/provider/<name>/` 创建目录
2. 实现 `Provider` 接口：
   ```go
   type Provider interface {
       GenerateCode(ctx, req) (*CodeResponse, error)
       Name() string
   }
   ```
3. 在 `factory.go` 添加 case
4. 添加测试文件
5. 更新文档

## 🐳 部署

### Docker 部署

```bash
# 构建镜像
docker build -t pilot-swe .

# 运行容器
docker run -d \
  -p 3000:3000 \
  -e GITHUB_APP_ID=123456 \
  -e GITHUB_PRIVATE_KEY="$(cat private-key.pem)" \
  -e GITHUB_WEBHOOK_SECRET=secret \
  -e ANTHROPIC_API_KEY=sk-ant-xxx \
  --name pilot-swe \
  pilot-swe
```

### Docker Compose

```yaml
version: "3.8"

services:
  pilot-swe:
    build: .
    ports:
      - "3000:3000"
    environment:
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_PRIVATE_KEY=${GITHUB_PRIVATE_KEY}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=claude-3-5-sonnet-20241022
      - TRIGGER_KEYWORD=/pilot
    restart: unless-stopped
```

## 📦 依赖

- **Go 1.25+** - 编译运行环境
- **Claude Code CLI** - AI 代码生成（通过 [lancekrogers/claude-code-go](https://github.com/lancekrogers/claude-code-go)）
- **GitHub CLI (`gh`)** - Git 操作
- **Gorilla Mux** - HTTP 路由

### AI Provider 支持

当前支持以下 AI provider：

- **Claude** (Anthropic) - 默认 provider，需要 `ANTHROPIC_API_KEY`
- **Codex** - 需要 `CODEX_API_KEY`

通过环境变量 `PROVIDER=claude` 或 `PROVIDER=codex` 切换。

## ⚡ 当前能力

### ✅ v0.1 MVP 已实现

- ✅ 响应 `issue_comment` 事件中的 `/pilot` 命令
- ✅ HMAC SHA-256 webhook 签名验证（防伪造）
- ✅ 调用 Claude Code CLI 生成代码修改
- ✅ 多 Provider 支持：Claude + Codex
- ✅ 自动 clone、修改、commit、push 到新分支
- ✅ 创建 PR 链接并回复到原评论
- ✅ Provider 接口抽象（易于扩展到其他 AI）
- ✅ Docker 部署支持
- ✅ 错误自动通知到 GitHub 评论
- ✅ 65.3% 测试覆盖率

### ❌ 当前限制

- ❌ 不支持 PR review comments 触发
- ❌ 不支持并发控制（同一 PR 同时多个命令会冲突）
- ❌ 不支持进度追踪（无法实时更新评论）
- ❌ 不支持任务队列（webhook 超时后无重试）

## 🗺️ 路线图

### v0.2 - 生产就绪

- [ ] **PR review comments 支持** - 在代码行添加评论触发
- [ ] **任务队列** - Redis 或内存队列，支持重试
- [ ] **并发控制** - 每个 PR/Issue 同时只能一个任务
- [ ] **速率限制** - 防止滥用（每仓库/小时限制）
- [ ] **进度追踪** - 实时更新评论显示执行进度
- [ ] **日志改进** - 结构化日志（JSON）+ 日志级别

### v0.3 - 功能扩展

- [ ] **更多 AI Provider**
  - [ ] Google Gemini provider
  - [ ] 其他 LLM provider
  - [ ] 可配置 provider 选择策略
- [ ] **Web UI** - 任务监控、配置管理界面
- [ ] **指标和监控** - Prometheus metrics + Grafana
- [ ] **一键部署** - Railway/Render/Vercel 部署按钮

### v0.4 - 企业特性

- [ ] **团队权限管理** - 限制谁可以触发
- [ ] **成本控制** - API 费用预算和告警
- [ ] **审计日志** - 所有操作记录
- [ ] **Webhook 重放** - 手动重试失败的任务
- [ ] **多仓库管理** - 统一配置多个仓库

## 🔒 安全注意事项

| 项目             | 状态      | 说明                       |
| ---------------- | --------- | -------------------------- |
| Webhook 签名验证 | ✅ 已实现 | HMAC SHA-256               |
| 常量时间比较     | ✅ 已实现 | 防止时序攻击               |
| API 密钥管理     | ⚠️ 建议   | 使用环境变量或密钥管理服务 |
| 速率限制         | ❌ 待实现 | v0.2 计划                  |
| 并发控制         | ❌ 待实现 | v0.2 计划                  |

## 🛠️ 故障排查

### 1. Webhook 未触发

检查：

- GitHub App 是否正确安装
- Webhook URL 是否可访问
- Webhook secret 是否匹配
- 查看 GitHub App 的 Recent Deliveries

### 2. Claude API 错误

检查：

- `ANTHROPIC_API_KEY` 是否正确
- API 配额是否用完
- 网络连接是否正常
- Claude Code CLI 是否正确安装

### 3. Git 操作失败

检查：

- `gh` CLI 是否安装并认证
- GitHub App 是否有 Contents 写权限
- 分支名是否冲突
- 网络连接是否稳定

## 🎯 设计哲学（Linus 风格）

### 1. 简单胜于复杂

- **单一职责：** 每个包只做一件事
- **清晰命名：** `provider.Provider` 而非 `AIService`
- **浅层缩进：** 函数不超过 3 层缩进

### 2. 好品味的代码

```go
// ❌ 坏品味：特殊分支地狱
if provider == "claude" {
    callClaude()
} else if provider == "codex" {
    callCodex()
} else if provider == "gemini" {
    callGemini()
}

// ✅ 好品味：接口抽象
provider.GenerateCode(req)  // 多态，零分支
```

### 3. 向后兼容

- Provider 接口设计支持未来扩展
- 配置向前兼容（新增字段有默认值）
- API 不做破坏性变更

### 4. 实用主义

- 直接调用 CLI 而非重新实现（站在巨人肩上）
- 使用 `gh` CLI 而非复杂的 GitHub API 库
- 错误直接反馈到 GitHub，而非藏在日志里

## 🤝 贡献指南

欢迎提交 Issue 和 PR！

### 贡献流程

1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

### 代码风格

- 使用 `go fmt` 格式化
- 遵循 Linus 的"好品味"原则
- 函数不超过 50 行
- 避免深层嵌套
- 添加单元测试（目标覆盖率 >75%）

## 📄 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

- [Claude Code](https://github.com/anthropics/claude-code) - AI 代码助手
- [lancekrogers/claude-code-go](https://github.com/lancekrogers/claude-code-go) - Go SDK
- [GitHub CLI](https://cli.github.com/) - Git 操作工具
- [Gorilla Mux](https://github.com/gorilla/mux) - HTTP 路由库
- Linus Torvalds - "Good taste" 编程哲学

## 📞 联系方式

- **Issues**: [GitHub Issues](https://github.com/cexll/swe/issues)
- **Discussions**: [GitHub Discussions](https://github.com/cexll/swe/discussions)

---

<div align="center">

**如果这个项目对你有帮助，请给个 ⭐️ Star！**

Made with ❤️ by [cexll](https://github.com/cexll)

</div>
