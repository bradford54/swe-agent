# Pilot SWE - Software Engineering Agent

GitHub App webhook 服务，通过 `/pilot` 命令触发 AI 自动完成代码修改任务。

## ✨ 特性

- 🤖 **AI 驱动** - 基于 Claude Code CLI，可扩展多 AI provider
- 🔐 **安全验证** - GitHub webhook 签名验证（HMAC SHA-256）
- ⚡ **异步处理** - 立即响应 webhook，后台执行任务
- 📦 **自动化流程** - Clone → AI 修改 → Commit → Push → 创建 PR 链接
- 🎯 **可配置触发词** - 默认 `/pilot`，可自定义
- 🎨 **Clean Architecture** - Provider 接口抽象，易于扩展

## 📊 项目统计

- **代码量：** 12 个 Go 文件，~800 行代码
- **编译产物：** 8.3MB 单一二进制文件
- **依赖：** Minimal - Go 1.21+, Claude Code CLI, GitHub CLI
- **性能：** 启动时间 ~100ms，内存占用 ~50MB

## 快速开始

### 环境变量

```bash
# GitHub App 配置
GITHUB_APP_ID=123456
GITHUB_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n..."
GITHUB_WEBHOOK_SECRET=your-webhook-secret

# Claude API
ANTHROPIC_API_KEY=sk-ant-xxx
CLAUDE_MODEL=claude-3-5-sonnet-20241022

# 可选配置
TRIGGER_KEYWORD=/pilot
PORT=3000
```

### 本地运行

```bash
# 1. 克隆项目
git clone <repo-url>
cd swe

# 2. 安装依赖
go mod download

# 3. 设置环境变量
export ANTHROPIC_API_KEY=sk-ant-xxx
export GITHUB_APP_ID=123456
# ... 其他环境变量

# 4. 运行
go run cmd/main.go
```

### Docker 部署

```bash
# 构建镜像
docker build -t pilot-swe .

# 运行容器
docker run -d \
  -p 3000:3000 \
  -e GITHUB_APP_ID=123456 \
  -e GITHUB_PRIVATE_KEY="$(cat private-key.pem)" \
  -e GITHUB_WEBHOOK_SECRET=secret \
  -e ANTHROPIC_API_KEY=sk-ant-xxx \
  --name pilot-swe \
  pilot-swe
```

## 使用方法

### 1. 配置 GitHub App

1. 创建 GitHub App：https://github.com/settings/apps/new
2. 权限设置：
   - Repository permissions:
     - Contents: Read & Write
     - Issues: Read & Write
     - Pull requests: Read & Write
   - Subscribe to events:
     - Issue comments
3. Webhook 设置：
   - URL: `https://your-domain.com/webhook`
   - Secret: 生成一个随机密钥
4. 安装到仓库

### 2. 在 Issue/PR 评论中触发

```markdown
/pilot fix the typo in README.md

/pilot add error handling to the main function

/pilot refactor the database connection code
```

### 3. Pilot 自动执行

1. ✅ Clone 仓库
2. ✅ 调用 Claude API 生成修改
3. ✅ 应用修改并 commit
4. ✅ Push 到新分支
5. ✅ 回复评论，包含 PR 创建链接

### 4. 查看结果

Pilot 会在原评论下回复：

```markdown
### ✅ Task Completed Successfully

**Summary:** Fixed typo in README.md

**Modified Files:** (1)

- `README.md`

**Next Step:**
[🚀 Click here to create Pull Request](https://github.com/owner/repo/compare/main...pilot/123-1234567890?expand=1)

---

_Generated by Pilot SWE_
```

## API 端点

### POST /webhook

接收 GitHub webhook 事件

**Headers:**

- `X-Hub-Signature-256`: GitHub webhook 签名
- `Content-Type`: application/json

**Body:** GitHub issue_comment event payload

### GET /health

健康检查端点

**Response:** `200 OK`

### GET /

服务信息

**Response:**

```json
{
  "service": "pilot-swe",
  "status": "running",
  "trigger": "/pilot"
}
```

## 🏗️ 架构设计

### 目录结构

```
swe/
├── cmd/
│   └── main.go                    # HTTP 服务器入口
├── internal/
│   ├── config/
│   │   └── config.go              # 配置管理
│   ├── webhook/
│   │   ├── handler.go             # Webhook 事件处理
│   │   ├── verify.go              # HMAC 签名验证
│   │   └── types.go               # Webhook payload 类型
│   ├── provider/
│   │   ├── provider.go            # Provider 接口定义
│   │   ├── factory.go             # Provider 工厂
│   │   └── claude/
│   │       └── claude.go          # Claude Provider 实现
│   ├── github/
│   │   ├── clone.go               # gh repo clone
│   │   ├── comment.go             # gh issue comment
│   │   └── pr.go                  # gh pr create
│   └── executor/
│       └── task.go                # 任务执行器（核心流程）
├── Dockerfile
├── .env.example
├── .gitignore
├── go.mod
└── README.md
```

### 架构亮点（Linus 风格）

#### 1. **Provider 抽象** - 消除特殊分支

```go
// 好品味的设计：无 if provider == "claude" 分支
type Provider interface {
    GenerateCode(ctx context.Context, req *CodeRequest) (*CodeResponse, error)
    Name() string
}

// 工厂模式统一创建
provider.NewProvider(&Config{
    Name:         "claude",  // 未来可改为 "codex", "gemini"
    ClaudeAPIKey: "...",
})

// 新增 provider 只需：
// 1. 实现 Provider 接口
// 2. 在 factory.go 添加 case
// 零修改现有代码！
```

#### 2. **清晰的数据流**

```
GitHub Webhook
      ↓
  Handler (验证签名)
      ↓
  Executor (编排)
      ↓
  Provider (AI 生成)
      ↓
  GitHub Ops (操作)
      ↓
  Comment (反馈)
```

#### 3. **错误处理策略**

```go
// 失败时自动回复错误评论到 GitHub
if err != nil {
    return e.notifyError(task, errorMsg)
    // 用户在 GitHub 看到详细错误，无需查日志
}
```

### 核心组件

| 组件            | 职责                                         | 文件数 |
| --------------- | -------------------------------------------- | ------ |
| Webhook Handler | 接收、验证、解析 GitHub 事件                 | 3      |
| Provider        | AI 代码生成抽象层                            | 3      |
| Executor        | 任务编排（Clone → Generate → Commit → Push） | 1      |
| GitHub Ops      | Git 操作封装（基于 gh CLI）                  | 3      |
| Config          | 环境变量管理和验证                           | 1      |

## 📦 依赖

- **Go 1.21+** - 编译运行环境
- **Claude Code CLI** - AI 代码生成（通过 lancekrogers/claude-code-go）
- **GitHub CLI (`gh`)** - Git 操作
- **Gorilla Mux** - HTTP 路由

## ⚡ 当前能力

### ✅ v0.1 MVP 已实现

- ✅ 响应 `issue_comment` 事件中的 `/pilot` 命令
- ✅ HMAC SHA-256 webhook 签名验证（防伪造）
- ✅ 调用 Claude Code CLI 生成代码修改
- ✅ 自动 clone、修改、commit、push 到新分支
- ✅ 创建 PR 链接并回复到原评论
- ✅ Provider 接口抽象（易于扩展到其他 AI）
- ✅ Docker 部署支持
- ✅ 错误自动通知到 GitHub 评论

### ❌ 当前限制

- ❌ 不支持 PR review comments 触发
- ❌ 不支持并发控制（同一 PR 同时多个命令会冲突）
- ❌ 不支持进度追踪（无法实时更新评论）
- ❌ 不支持任务队列（webhook 超时后无重试）
- ❌ 仅支持 Claude provider（Codex/Gemini 待实现）

## 🗺️ 路线图

### v0.2 - 生产就绪

- [ ] **PR review comments 支持** - 在代码行添加评论触发
- [ ] **任务队列** - Redis 或内存队列，支持重试
- [ ] **并发控制** - 每个 PR/Issue 同时只能一个任务
- [ ] **速率限制** - 防止滥用（每仓库/小时限制）
- [ ] **进度追踪** - 实时更新评论显示执行进度
- [ ] **日志改进** - 结构化日志（JSON）+ 日志级别

### v0.3 - 功能扩展

- [ ] **多 AI Provider**
  - [ ] OpenAI Codex provider
  - [ ] Google Gemini provider
  - [ ] AMP provider
  - [ ] 可配置 provider 选择
- [ ] **Web UI** - 任务监控、配置管理界面
- [ ] **指标和监控** - Prometheus metrics + Grafana
- [ ] **一键部署** - Railway/Render/Vercel 部署按钮

### v0.4 - 企业特性

- [ ] **团队权限管理** - 限制谁可以触发
- [ ] **成本控制** - API 费用预算和告警
- [ ] **审计日志** - 所有操作记录
- [ ] **Webhook 重放** - 手动重试失败的任务
- [ ] **多仓库管理** - 统一配置多个仓库

## 安全注意事项

1. ✅ **Webhook 签名验证** - 使用 HMAC SHA-256
2. ✅ **常量时间比较** - 防止时序攻击
3. ⚠️ **API 密钥管理** - 使用环境变量或密钥管理服务
4. ⚠️ **速率限制** - 建议添加（v0.2）
5. ⚠️ **并发控制** - 建议添加（v0.2）

## 限制（v0.1 MVP）

- ❌ 不支持 PR review comments
- ❌ 不支持并发执行（同一 PR 多个命令）
- ❌ 不支持进度追踪（实时更新评论）
- ❌ 不支持任务队列
- ❌ 不支持除 Claude 外的其他 AI provider

## 路线图

### v0.2

- [ ] PR review comments 支持
- [ ] 队列系统和并发控制
- [ ] 速率限制
- [ ] 进度追踪（实时更新评论）

### v0.3

- [ ] 支持多 AI provider（Codex, Gemini, AMP）
- [ ] Web UI 管理界面
- [ ] 指标和监控
- [ ] 一键部署（Railway/Vercel）

## 故障排查

### 1. Webhook 未触发

检查：

- GitHub App 是否正确安装
- Webhook URL 是否可访问
- Webhook secret 是否匹配

### 2. Claude API 错误

检查：

- `ANTHROPIC_API_KEY` 是否正确
- API 配额是否用完
- 网络连接是否正常

### 3. Git 操作失败

检查：

- `gh` CLI 是否安装并认证
- GitHub App 是否有 Contents 写权限
- 分支名是否冲突

## 🎯 设计哲学（Linus 风格）

### 1. 简单胜于复杂

- **单一职责：** 每个包只做一件事
- **清晰命名：** `provider.Provider` 而非 `AIService`
- **浅层缩进：** 函数不超过 3 层缩进

### 2. 好品味的代码

```go
// ❌ 坏品味：特殊分支地狱
if provider == "claude" {
    callClaude()
} else if provider == "codex" {
    callCodex()
} else if provider == "gemini" {
    callGemini()
}

// ✅ 好品味：接口抽象
provider.GenerateCode(req)  // 多态，零分支
```

### 3. 向后兼容

- Provider 接口设计支持未来扩展
- 配置向前兼容（新增字段有默认值）
- API 不做破坏性变更

### 4. 实用主义

- 直接调用 CLI 而非重新实现（站在巨人肩上）
- 使用 `gh` CLI 而非复杂的 GitHub API 库
- 错误直接反馈到 GitHub，而非藏在日志里

## 🤝 贡献指南

欢迎提交 Issue 和 PR！

### 添加新的 AI Provider

1. 在 `internal/provider/<name>/` 创建目录
2. 实现 `Provider` 接口：
   ```go
   type Provider interface {
       GenerateCode(ctx, req) (*CodeResponse, error)
       Name() string
   }
   ```
3. 在 `factory.go` 添加 case
4. 更新文档

### 代码风格

- 使用 `go fmt` 格式化
- 遵循 Linus 的"好品味"原则
- 函数不超过 50 行
- 避免深层嵌套

## 📄 许可证

MIT License

## 🙏 致谢

- [Claude Code](https://github.com/anthropics/claude-code) - AI 代码助手
- [lancekrogers/claude-code-go](https://github.com/lancekrogers/claude-code-go) - Go SDK
- [GitHub CLI](https://cli.github.com/) - Git 操作工具
- Linus Torvalds - "Good taste" 编程哲学
