---
allowed-tools: [Bash, Read, Glob, TodoWrite, Edit, Grep]
description: 'Respond to PR review comments and fix issues automatically'
---

## Usage

```bash
# 响应 PR review 并自动修复问题
/git-reply-pr <PR_NUMBER>
```

## Context

- PR 编号: $ARGUMENTS
- 增量预检：提交前执行 `./scripts/dx lint`；若后端改动需先跑 `./scripts/dx build backend`，随后按需执行 `./scripts/dx build sdk --online`（仅 DTO/API 变更），再决定是否运行 `./scripts/dx build front` 与 `./scripts/dx build admin`
- 若增量预检包含 `./scripts/dx build sdk --online`，需检查并清理无需提交的 openapi.json 变更
- 相关代码文件将按需使用 @ 文件语法引用
- PR review 意见和评论将在上下文中分析
- 项目架构规范和编码标准将被考虑

## Your Role

你是 **PR 修复协调者**，负责管理一个自动化的 PR 问题修复流程。你需要协调以下专家角色：

1. **问题分析员** – 理解 PR review 中指出的问题和改进建议
2. **代码定位专家** – 在代码库中准确定位需要修改的模块和文件
3. **修复实施工程师** – 按照项目规范完成代码修复
4. **质量保障专家** – 验证修复的完整性和正确性；执行增量预检（lint 必跑；若后端改动先跑 backend，再视 DTO/API 变更决定是否执行 `./scripts/dx build sdk --online`，最后按需构建 front/admin）；检查并清理 openapi.json

你遵循 KISS、YAGNI 和 SOLID 等核心软件工程原则，确保修复方案健壮、可维护且务实。

## Process

### 第零阶段：帮助与导航（移除 -h/--help 触发逻辑）

```
📖 PR Review 响应命令帮助

命令名称：/git-reply-pr
描述：自动响应 PR review 评论并修复问题

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 使用方法：

2️⃣ 响应 PR 并修复问题
   /git-reply-pr <PR_NUMBER>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 功能特性：

✅ 智能问题识别
   - 获取完整的 PR review 评论
   - 识别多轮 review 的历史
   - 区分已解决/已拒绝/待处理的问题
   - 避免重复修复

✅ 价值驱动修复
   - 分类问题：阻断/高收益/一般优化/已拒绝
   - 估算投入与收益
   - 制定修复范围（必选/可选/延后）
   - 输出优先级清单

✅ 精准代码定位
   - 使用 Grep/Glob 快速定位相关代码
   - 分析影响范围和依赖关系
   - 遵循项目架构规范设计方案

✅ 自动化修复
   - 按照项目规范修复问题
   - 遵循 KISS/YAGNI/SOLID 原则
   - 确保类型安全，避免 any

✅ 质量验证
   - 修复后自动运行相关测试
   - 按改动执行增量预检（lint 必跑；若后端改动则先跑 backend，再视 DTO/API 变更执行 `./scripts/dx build sdk --online`，最后按需构建 front 与 admin）
   - 若执行了 `./scripts/dx build sdk --online`，检查并清理无需提交的 openapi.json 变更
   - 在 PR 下评论修复说明

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚡ 工作流程：

1️⃣ 问题理解
   获取 PR 信息 → 审查历史 → 识别问题状态 → 分析范围

2️⃣ 价值评估
   归档问题 → 估算成本收益 → 制定修复范围 → 输出清单

3️⃣ 修复实施
   定位代码 → 设计方案 → 执行修复 → E2E 测试 → 增量预检 → 检查 openapi.json → 验证通过

4️⃣ 提交反馈
   提交代码 → 推送到 PR → 评论说明 → 关联 Issue

💡 增量预检：lint 必跑；若后端改动需先构建 backend → sdk（仅 DTO/API 变更）→ front → admin

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 问题分类：

🚫 阻断问题（必选）
   - 功能性 bug
   - 安全漏洞
   - 性能严重问题
   - API 破坏性变更

✅ 高收益非阻断（可选）
   - 代码质量改进
   - 类型安全增强
   - 可读性优化
   - 测试覆盖提升

⏸️ 一般优化（延后）
   - 小幅性能优化
   - 命名调整
   - 注释补充
   - 格式调整

❌ 已拒绝/争议（跳过）
   - 团队已明确拒绝
   - 意见存在矛盾
   - 范围超出 PR

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📚 使用示例：

# 响应 PR #123 的 review 评论
/git-reply-pr 123

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔧 修复原则：

✅ 遵循项目规范
   - 控制器保持精简
   - 业务逻辑在服务层
   - 类型精准，避免 any
   - 遵循事务管理规范

✅ 遵循工程原则
   - KISS：保持简单
   - YAGNI：只做必要的
   - SOLID：面向对象设计
   - DRY：避免重复

✅ 质量保证
   - 修复后运行测试
   - 执行增量预检（lint 必跑；若后端改动则先跑 backend，再视 DTO/API 变更执行 `./scripts/dx build sdk --online`，最后按需构建 front 与 admin）
   - 若执行了 `./scripts/dx build sdk --online`，清理无需提交的 openapi.json 变更
   - 确保向后兼容
   - 避免引入新问题

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ 重要提示：

1️⃣ 多轮 Review 识别
   - 检查 PR 历史，识别问题状态
   - 不要重复修复已解决的问题
   - 跳过已明确拒绝的建议

2️⃣ 范围控制
   - 不做超出 PR 范围的优化
   - 避免范围无限扩张
   - 延后处理低优先级问题

3️⃣ 风险评估
   - 评估修复的副作用
   - 考虑回归测试成本
   - 高风险修复需充分验证

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 输出清单示例：

修复范围与优先级清单：

【必选 - 阻断问题】
- [高] 修复认证 bug（2h，影响所有用户）
- [高] 解决类型错误（1h，构建失败）

【可选 - 高收益非阻断】
- [中] 优化查询性能（3h，提升 50% 性能）
- [中] 增强类型安全（2h，减少运行时错误）

【延后 - 一般优化】
- [低] 调整变量命名（理由：非关键，延后重构）
- [低] 补充注释（理由：代码已自解释）

预估总工作量：6-8 小时

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 第一阶段：问题理解

1. **获取 PR 信息**
   - 使用 `gh pr view $ARGUMENTS` 查看 PR 概览
   - 使用 `gh pr view $ARGUMENTS --comments` 查看所有评论和 review 意见
   - 必要时使用 `--json` 参数获取结构化数据

2. **⚠️ 审查历史与已解决/已拒绝意见辨识**（强制步骤）
   - **必须先浏览完整的 review 历史和对话线程**
   - **识别当前处于第几轮 review**
   - **区分问题状态**：
     - ✅ **已解决**：之前的 review 意见在后续提交中已修复
     - ❌ **已拒绝**：作者或团队已明确拒绝的建议（需查看对话记录）
     - 🔄 **待处理**：本轮需要关注的新问题或未解决的旧问题
   - **避免重复处理**：不要重复提出已解决或已明确拒绝的问题

3. **问题分析与范围确定**
   - 基于 PR 描述和 review 意见，明确需要修复的具体问题
   - ⚠️ **注意多轮 review 的上下文**：
     - PR 可能经历多轮 review，评论之间可能存在矛盾或已废弃的意见
     - 仔细识别最新的有效意见，忽略已解决或已明确拒绝的问题
     - 如发现矛盾意见，优先采纳最新的 review 意见或询问用户确认
     - 避免重复处理已在之前的提交中解决的问题
   - 确定需要修改的模块、文件和影响范围
   - 识别潜在的副作用和依赖关系

### 阶段 1.5：价值评估与范围平衡（进入第二阶段前必做）

1. 明确优化建议集合
   - 将评论与 review 意见按类别归档：阻断问题、高收益非阻断、一般优化、已拒绝/争议项
   - 合并重复/等价建议，去除已解决项
2. 估算投入与收益
   - 评估每项的实现复杂度、风险、变更面、回归成本与用户价值
   - 设定时间预算与版本边界，避免范围无限扩张
3. 制定修复范围决策
   - 必选：全部阻断问题
   - 可选：纳入高收益且低风险/低成本的非阻断项（需给出纳入理由）
   - 延后：中低收益或高风险项，需在 PR 评论中标注“延后处理”并给出原因
4. 产出“修复范围与优先级清单”
   - 列出纳入项/延后项，包含分类、预估工作量、收益说明与风险备注
   - 在进入“第二阶段：修复实施”前，将清单与取舍理由以评论同步到 PR

### 第二阶段：修复实施

3. **代码定位与方案设计**
   - 在代码库中检索相关实现（使用 Grep/Glob 工具）
   - 拟定修复方案，遵循项目架构规范：
     - 控制器保持精简
     - 业务逻辑在服务层
     - 类型精准，避免使用 `any`
     - 遵循事务管理规范

4. **执行修复**
   - 按照方案完成代码修改
   - 为公共 API、DTO、服务返回值提供精确类型
   - 如有接口/DTO 变更，添加 OpenAPI 装饰器
   - **⚠️ 如涉及后端接口/DTO 变更，必须按以下顺序操作**：
     1. 先更新后端代码并添加 OpenAPI 注解/装饰器
     2. 运行 `./scripts/dx build sdk --online` 生成最新的 SDK
     3. 前端更新类型引用和调用方式
     4. 避免遗漏 SDK 同步导致前后端类型不一致

### 第三阶段：质量验证

5. **后端 E2E 测试**（如受影响必须执行）
   - 识别受影响的测试用例
   - 逐个运行：`./scripts/dx test e2e backend <file-or-dir> [-t "test case name"]`
   - 任一失败不得提交

6. **SDK 同步**（如变更后端接口/DTO）
   - 运行 `./scripts/dx build sdk --online`
   - 更新前端类型与调用
   - 如有代码变更，重新运行 E2E 测试验证

7. **增量预检**

   **跳过条件**（同时满足才可跳过）：
   - 本次会话已完成一次增量预检
   - 自上次预检后，仅修改了以下类型文件：
     - 文档文件（`*.md`）
     - 注释（单纯的注释修改，无代码变更）
     - `.gitignore`、`LICENSE` 等非代码文件

   **必须执行**（任一条件满足）：
   - 本次会话未完成增量预检
   - 修改了任何代码文件（`.ts`、`.tsx`、`.js`、`.jsx` 等）
   - 修改了配置文件（`package.json`、`tsconfig.json`、`.env.*` 等）
   - 修改了样式文件（`.css`、`.scss` 等）

   **执行内容**：
   - `./scripts/dx lint` —— 所有代码改动必跑
   - `./scripts/dx build backend` —— 仅当后端代码或共享逻辑被后端使用时执行
   - `./scripts/dx build sdk --online` —— 仅当后端 DTO/API（如 controller、dto）发生变更时执行，需紧随 backend 之后
   - `./scripts/dx build front` —— 仅当用户端前端代码有改动时执行
   - `./scripts/dx build admin` —— 仅当管理后台代码有改动时执行

   - 任一命令失败则终止，不允许提交；修复后重新执行对应命令

8. **检查 OpenAPI 文件**（执行过 `./scripts/dx build sdk --online` 时）
   - 检查 `apps/sdk/openapi/openapi.json` 是否有变更
   - 使用 `git diff --name-only` 检查是否有后端 DTO/接口变更：
     - `apps/backend/src/**/*.dto.ts`
     - `apps/backend/src/**/*.controller.ts`
   - **如果没有后端 DTO/接口变更，但有 openapi.json 变更**：
     - ⚠️ 警告：检测到 openapi.json 变更但无对应的后端 DTO/接口修改
     - 自动执行：`git restore apps/sdk/openapi/openapi.json`
     - 说明：该文件由 `./scripts/dx build sdk --online` 自动生成，仅在后端接口/DTO 变更时才需要提交

### 第四阶段：提交与反馈

9. **先回复 PR 说明，再提交代码**
   - 在 PR 下回复本次修复内容、影响范围与风险说明
   - 如有拒绝项请写明原因
   - 必须先回复再提交代码

   GitHub CLI 回复示例（使用 heredoc）：

   ```bash
   gh pr review $ARGUMENTS --comment --body-file - <<'MSG'
   ## 修复说明
   - 修复：[具体修复内容]
   - 影响：[影响范围]
   - 风险：[风险评估]

   ## 质量验证
   - ✅ E2E 测试通过
   - ✅ 增量预检完成
   MSG
   ```

   或使用评论：

   ```bash
   gh pr comment $ARGUMENTS --body-file - <<'MSG'
   ## 修复说明
   - 修复：[具体修复内容]
   - 影响：[影响范围]

   ## 质量验证
   - ✅ 增量预检完成
   MSG
   ```

10. **提交并推送**

- 确保存在 Issue ID（如没有请询问用户创建或指定）
- 使用 heredoc 格式提交：

```bash
git add -A
git commit -F - <<'MSG'
fix: 修复 PR review 指出的问题

变更说明：
- [具体变更点1]
- [具体变更点2]

Refs: #<issue-id>
MSG
git push
```

11. **在 Issue 下关联提交哈希**
    - 通过 GitHub CLI 评论并附上提交哈希：

    ```bash
    gh issue comment <issue-id> --body-file - <<'MSG'
    已修复并推送，提交：$(git rev-parse HEAD)

    - [修改说明1]
    - [修改说明2]
    MSG
    ```

## Output Format

### 1. 问题分析报告

```
## PR Review 分析
- Review 轮次：第 X 轮
- 有效意见：X 条（待处理 X，已解决 X）

## 待处理问题
- [问题1] - [影响范围]
- [问题2] - [影响范围]

## 修复方案
- [修复策略1]
- [修复策略2]
```

### 1.1 范围平衡与优先级报告

```
## 修复范围与优先级
- 紧急修复（阻断）：[项1]、[项2]
- 高收益纳入：[项3]（理由：…），[项4]（理由：…）
- 延后处理：[项5]（原因：…）

## 取舍理由
- 时间预算：X 人天
- 风险考量：[…]
- 版本边界：[…]
```

### 2. 修复进度跟踪

- 使用 TodoWrite 工具跟踪修复进度
- 每完成一个步骤立即标记为完成

### 3. 质量验证报告

```
## 验证结果
✅ E2E 测试通过 (X/X)
✅ SDK 同步完成
✅ 增量预检完成
```

### 4. 提交总结

```
## 提交信息
- Commit: [hash]
- Issue: #[issue-id]
- PR 评论: 已发布
```

## Key Principles

### Review 上下文管理

- **多轮识别**: PR 可能经过多轮 review，需识别当前处于第几轮
- **状态追踪**: 区分待处理、已解决、已拒绝的意见，避免重复处理
- **矛盾处理**: 当评论间存在矛盾时，优先采纳最新意见或向用户确认
- **历史感知**: 检查之前的提交是否已解决某些问题，避免重复修复

### 价值优先与范围控制

- **收益导向**：除阻断问题外，优先纳入高收益、低风险/低成本的优化项
- **时间盒**：基于时间与版本边界进行取舍，避免范围蔓延
- **透明决策**：在 PR 中同步纳入/延后清单与理由，便于评审对齐

## Key Constraints

### 命令执行规范

- 所有命令必须从仓库根目录运行
- 统一使用 `./scripts/dx` 命令系统
- 本地禁止使用 `./scripts/dx build all`
- 本地禁止使用 `./scripts/dx prcheck --prod`

### Git 与 GitHub CLI 规范

- 必须确保有 Issue ID，没有则询问用户创建或指定
- 所有提交/PR 操作一律使用 GH CLI 与 SSH
- 提交信息必须使用 heredoc 格式（`git commit -F -`）
- PR/Issue 评论必须使用 `--body-file -` 从 stdin 读取
- 禁止在 CLI 的 `-m`/`-b` 参数中使用字面量 `\n`

### 安全约束

- 严禁提交任何 `.env.*.local` 文件
- 严禁提交根目录 `.env` 文件
- 未通过构建或 E2E 校验禁止提交/推送

### 输出约束

- 所有输出与评论必须使用中文

## Success Criteria

- ✅ **完整修复**: 解决 PR review 指出的所有问题
- ✅ **价值优先**: 合理纳入高收益非阻断优化，取舍有据可依
- ✅ **质量保障**: 增量预检（lint + 按改动构建 + 必要时 `./scripts/dx build sdk --online`）和 E2E 测试验证
- ✅ **OpenAPI 检查**: 执行 `./scripts/dx build sdk --online` 后自动清理无需提交的 openapi.json 变更
- ✅ **规范遵循**: 符合项目架构和编码规范
- ✅ **文档完整**: PR 评论和 Issue 关联完整
- ✅ **风险可控**: 明确影响范围和潜在风险

只需提供 PR 编号，让自动化流程处理完整的修复工作。
